---
title: 'Code summary (Eng): models and PEVD'
author: "Eva Lavrencic"
output:
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(INLA)
library(sf) #spatial
library(spdep) #spatial
library(rgdal) #spatial
library(tidyverse)
library(Matrix)
library(kableExtra)
library(gdata) # drop unused factor levels

#(devtools)
#library(RcppArmadillo)
#find_rtools() # TRUE
#has_devel()
```



# IMPORTING DATA

```{r}
load("workspaces/import_data.RData")
load("workspaces/model_comparison.RData")
```

- phenoData = original dataset, 30314x30, data on Brown-Swiss cattle from Slovenia (years 2004-2019 from 2012 different herds)
- Ainv = inverse of the relationship matrix (56465x56465)
- boundaryOB = map of municipalities (sf data.frame class)
- boundaryUE = map of administrative units (sf data.frame class)
- mapOB = map of municipalities (SpatialPolygonsDataFrame class)
- mapUE = map of administrative units (SpatialPolygonsDataFrame class)
- sloveniaBoundary = map of Slovenia



```{r}
# importing results
# load("workspaces/full_models.RData")
# load("workspaces/Eucl_models.RData")
# load("workspaces/spde_big.RData")
# load("workspaces/spde_small.RData")
# load("workspaces/UE_models.RData")
# load("workspaces/mc_samples.RData")
# load("workspaces/small_models_with_MC.RData")
# Eucl_dist <- read.table("workspaces/Euclidean_dist_small.txt", sep=" ")
# Eucl_dist <- data.matrix(Eucl_dist)

```


# MODEL DESCRIPTION

We analysed  a physical trait describing a body confirmation measure as a response variable (last004_scaled). In all models we included 3 fixed effects: year and scorer of the data (vpliv1), cattle age and stage of lactation (vpliv2) and year and month of calving (vpliv3). We included 3 fixed effects: genetic/pedigree effect (G), herd effect (H) and herd location effect (S) in different combinations (see below):

G: $y_i = x_i \beta + a_i + e_i$; 

GH: $y_i = x_i \beta + a_i + h_i + e_i$; 

GS: $y_i = x_i \beta + a_i + s_i + e_i$; 

GHS: $y_i = x_i \beta + a_i + h_i + s_i + e_i$


- $\beta$ = vector of fixed covariate effects, $x_i$ = covariate vector
- $a_i$ = additive genetic effects (breeding value); modelled using pedigree relationship matrix A
- $h_i$ = herd effect; modelled using herd ids
- $s_i$ = spatial effect; modelled in 3 different ways
- $e_i$ = residual effect



## SPATIAL EFFECT MODELLING

- BESAG/CAR (regional model)
- using Euclidean distances covariance matrix (geostatistical model)
- SPDE (geostatical model)

BESAG/CAR and model based on Euclidean distances were fitted in INLA-R and BLUPF90. SPDE model was fitted in INLA-R.


# HYPOTHESES

- Accounting for spatial relationships can improve genetic evaluation [low genetic connectedness between small herds, relatively high environmental variation setting]
- Accounting for spatial relationships can improve genetic connectedness between animals


# DATA PREPARATION

## REGIONAL NEIGBORHOOD MATRIX (accounting for neighborhood structure in BESAG/CAR model)

Neigborhood matrix can be constructed using 'inla.read.graph' function. Construsted graph contains information on number and ids of neighbouring regions for every region. Then, the region id (UE_MID and OB_MID) in the phenoData dataset is merged with the consecutive id number of the region (1 to number of regions).

```{r}
# administrative units
nb.mapUE <- poly2nb(mapUE) #class nb
nb2INLA("map.graphUE",nb.mapUE)
gUE <- inla.read.graph(filename = "map.graphUE")

#obcine
nb.mapOB <- poly2nb(mapOB)
nb2INLA("map.graphOB",nb.mapOB)
gOB <- inla.read.graph(filename = "map.graphOB")
```



```{r}
# assinging a sequence number to regional id
grafID_UE <- data.frame("UE" = mapUE[,"UE_MID"], "idUE" = mapUE[,"UE_ID"])
names(grafID_UE) <- c("UE", "idUE")
grafID_OB <- data.frame("OB" = mapOB[,"OB_MID"], "idOB" = mapOB[,"OB_ID"])
names(grafID_OB) <- c("OB", "idOB")

phenoData <- as.data.frame(merge(phenoData, grafID_UE, all.x=T))
phenoData <- as.data.frame(merge(phenoData, grafID_OB, all.x=T))
```



## DEFINING PRIORS


```{r eval=F}
# priors
hyperVarPed = list(theta = list(prior="pc.prec", param=c(0.1,0.5)))
hyperVarIdlok.GH = list(theta = list(prior="pc.prec", param=c(0.25,0.5)))
hyperVarIdlok.GHS = list(theta = list(prior="pc.prec", param=c(0.15,0.5)))
hyperResVarG = list(theta = list(prior="pc.prec", param=c(0.3,0.5)))
hyperResVarGHS = list(theta = list(prior="pc.prec", param=c(0.15,0.5)))
```




## PREPARING SUBSET OF DATA

- n = 3800
- sampling 3800 individuals without replacement, with sampling probability equal to the inverse herd size

```{r}
# podset podatkov
herd_n <- data.frame(table(phenoData$idlok))
colnames(herd_n) <- c("idlok", "herd_n")
phenoData <- merge(phenoData, herd_n, all.x=T)
set.seed(85940)
phenoData.small <- phenoData[sample(1:nrow(phenoData), size = 3800, replace = FALSE, prob = 1/phenoData$herd_n),]
phenoData.small <- drop.levels(phenoData.small)
```



## SPDE MODEL PREPARATION (STACK) (Maria)

Full data.

```{r eval=F}
# Prior values
hyperRange  = c(50, 0.8)# <
hyperVarSpdeS = c(1, 0.05) # >
hyperVarSpdeHS = c(0.6, 0.05) # >

hyperVarPed = list(theta = list(prior="pc.prec", param=c(0.4,0.05)))
hyperVarIdlokH = list(theta = list(prior="pc.prec", param=c(1,0.05)))
hyperVarIdlokHS = list(theta = list(prior="pc.prec", param=c(0.6,0.05)))

hyperResVarG = list(theta = list(prior="pc.prec", param=c(1,0.1)))
hyperResVarRest = list(theta = list(prior="pc.prec", param=c(0.6,0.05)))

# Use model matrix to fit factor effects 
M = model.matrix(~1 + vpliv1 + vpliv2 + vpliv3, phenoData)
# Store in a stack
FactorNames =  tail(colnames(M), ncol(M)-1)
FactorStack = paste0( "list(", FactorNames, " = M[,", 2:(ncol(M)), "]),", collapse = "" )
FactorStack = ( gsub('.{1}$', '', FactorStack ) )
FactorStack= paste0("c(", FactorStack, ")")

# Make the formula
FormulaStack = paste("+", FactorNames, collapse = " ")  

formulaS.1 = 'last004scaled ~ intercept + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(fieldID, model = spdeStatS) -1'

formulaHS.1 = 'last004scaled ~intercept + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idlok, model = "iid", hyper = hyperVarIdlokHS) + f(fieldID, model = spdeStatHS) -1'

formulaS = as.formula( paste0(formulaS.1, FormulaStack))
formulaHS = as.formula( paste0(formulaHS.1, FormulaStack))

# Make mesh and SPDE 
mesh = inla.mesh.2d(cbind(phenoData$xpos, phenoData$ypos), max.edge=c(10, 20), cutoff = 2.5, offset = 30)
A = inla.spde.make.A(mesh = mesh, loc = cbind(phenoData$xpos, phenoData$ypos) )
spdeStatS = inla.spde2.pcmatern(mesh = mesh, alpha = 2 ,  prior.range = hyperRange, prior.sigma = hyperVarSpdeS)
meshIndexS = inla.spde.make.index(name = "fieldID", n.spde = spdeStatS$n.spde) 
spdeStatHS = inla.spde2.pcmatern(mesh = mesh, alpha = 2 ,  prior.range = hyperRange, prior.sigma = hyperVarSpdeS)
meshIndexHS = inla.spde.make.index(name = "fieldID", n.spde = spdeStatHS$n.spde) 

# Make stack
stack = inla.stack(data = list(last004scaled = phenoData$last004scaled),
                   A = list(A,1, 1),
                   effects = list(c(meshIndexS, list(intercept = 1)),
                                  c(list(rowNumberAinv = phenoData$rowNumberAinv),list(idlok = phenoData$idlok)),
                                  c(eval(parse(text = FactorStack ) ) )), tag = "est") 

stackHS = inla.stack(data = list(last004scaled = phenoData$last004scaled),
                     A = list(A,1, 1),
                     effects = list(c(meshIndexHS, list(intercept = 1)),
                                    c(list(rowNumberAinv = phenoData$rowNumberAinv),list(idlok = phenoData$idlok)),
                                    c(eval(parse(text = FactorStack ) ) ) ), tag = "est") 

 
```

Data subset.

```{r eval=F}
# Use model matrix to fit factor effects 
M.small = model.matrix(~1 + vpliv1 + vpliv2 + vpliv3, phenoData.small)
# Store in a stack
FactorNames.small =  tail(colnames(M.small), ncol(M.small)-1)
FactorStack.small = paste0( "list(", FactorNames.small, " = M.small[,", 2:(ncol(M.small)), "]),", collapse = "" )
FactorStack.small = ( gsub('.{1}$', '', FactorStack.small ) )
FactorStack.small= paste0("c(", FactorStack.small, ")")

# Make the formula
FormulaStack.small = paste("+", FactorNames.small, collapse = " ")  

formulaS.1.small = 'last004scaled ~ intercept + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(fieldID, model = spdeStatS) -1'

formulaHS.1.small = 'last004scaled ~intercept + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idlok, model = "iid", hyper = hyperVarIdlokHS) + f(fieldID, model = spdeStatHS) -1'

formulaS.small = as.formula( paste0(formulaS.1.small, FormulaStack.small))
formulaHS.small = as.formula( paste0(formulaHS.1.small, FormulaStack.small))

# Make mesh and SPDE 
mesh.small = inla.mesh.2d(cbind(phenoData.small$xpos, phenoData.small$ypos), max.edge=c(10, 20), cutoff = 2.5, offset = 30)
A.small = inla.spde.make.A(mesh = mesh.small, loc = cbind(phenoData.small$xpos, phenoData.small$ypos) )
spdeStatS.small = inla.spde2.pcmatern(mesh = mesh.small, alpha = 2 ,  prior.range = hyperRange, prior.sigma = hyperVarSpdeS)
meshIndexS.small = inla.spde.make.index(name = "fieldID", n.spde = spdeStatS.small$n.spde) 
spdeStatHS.small = inla.spde2.pcmatern(mesh = mesh.small, alpha = 2 ,  prior.range = hyperRange, prior.sigma = hyperVarSpdeS)
meshIndexHS.small = inla.spde.make.index(name = "fieldID", n.spde = spdeStatHS.small$n.spde) 

# Make stack
stack.small = inla.stack(data = list(last004scaled = phenoData.small$last004scaled),
                   A = list(A.small,1, 1),
                   effects = list(c(meshIndexS.small, list(intercept = 1)),
                                  c(list(rowNumberAinv = phenoData.small$rowNumberAinv),list(idlok = phenoData.small$idlok)),
                                  c(eval(parse(text = FactorStack.small ) ) )), tag = "est") 

stackHS.small = inla.stack(data = list(last004scaled = phenoData.small$last004scaled),
                     A = list(A.small,1, 1),
                     effects = list(c(meshIndexHS.small, list(intercept = 1)),
                                    c(list(rowNumberAinv = phenoData.small$rowNumberAinv),list(idlok = phenoData.small$idlok)),
                                    c(eval(parse(text = FactorStack.small ) ) ) ), tag = "est") 
 
```




## SET MODEL FORMULAS

Full dataset models.

```{r eval=F}
# G MODEL (G)
formulaB.G = last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3  +  f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed)
# H MODEL (G + H: herd effect)
formulaB.H = last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3  +  f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idlok, model = "iid", hyper = hyperVarIdlok.GH)
# S MODEL (G + field (regional effect)) BESAG
# UE = administrative regions
# OB = municipalities
formulaB.S.UE = last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3  +  f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idUE, model = "besagproper2", graph = gUE)
formulaB.S.OB = last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3  +  f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idOB, model = "besagproper2", graph = gOB)
# HS MODEL (G + location + field) BESAG
formulaB.HS.UE <- last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3 + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idlok, model = "iid", hyper = hyperVarIdlok.GHS) + f(idUE, model = "besagproper2", graph = gUE)
formulaB.HS.OB <- last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3 + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idlok, model = "iid", hyper = hyperVarIdlok.GHS) + f(idOB, model = "besagproper2", graph = gOB)

# Euclidean
formulaB.S.Eucl = last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3  +  f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idEucl, model = "generic0", Cmatrix = invEucl.big)
formulaB.HS.Eucl <- last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3 + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idlok, model = "iid", hyper = hyperVarIdlok.GHS) + f(idEucl, model = "generic0", Cmatrix = invEucl.big)

```

Data subset models.

```{r eval=F}
# Euclidean
formulaB.S.Eucl.small = last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3  +  f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idEucl, model = "generic0", Cmatrix = invEucl.small)

formulaB.HS.Eucl.small <- last004scaled ~ 1 + vpliv1 + vpliv2 + vpliv3 + f(rowNumberAinv, model = "generic0", Cmatrix = Ainv,hyper = hyperVarPed) + f(idlok, model = "iid", hyper = hyperVarIdlok.GHS) + f(idEucl, model = "generic0", Cmatrix = invEucl.small)
```


# FIT MODELS

Full dataset.

```{r eval=F}
model.G <- inla(formulaB.G,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
model.H <- inla(formulaB.H,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
model.besag.S.UE <- inla(formulaB.S.UE,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
model.besag.S.OB <- inla(formulaB.S.OB,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
model.besag.HS.UE <- inla(formulaB.HS.UE,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
model.besag.HS.OB <- inla(formulaB.HS.OB,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
# Euclidean
model.Eucl.S <- inla(formulaB.S.Eucl,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
model.Eucl.HS <- inla(formulaB.HS.Eucl,  family = "gaussian", data = phenoData, control.compute = list(dic=T,cpo=F,config=T), verbose=T)
# SPDE
model.SPDE.S = inla(formula = formulaS, data = inla.stack.data(stack),
            family = "normal", control.predictor =list(A=inla.stack.A(stack),compute = T),
            control.family=list(list(hyper=hyperResVarRest)),
            control.compute = list(dic=T,cpo=F), verbose=T) 
model.SPDE.HS = inla(formula = formulaHS, data = inla.stack.data(stackHS),
             family = "normal", control.predictor =list(A=inla.stack.A(stackHS),compute = T),
             control.family=list(list(hyper=hyperResVarRest)),
             control.compute = list(dic=T,cpo=F), verbose=T)
```

Data subset model fitting.

```{r eval=F}
model.G.small <- inla(formulaB.G.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, openmp.strategy="huge", config=T), verbose=T)
model.H.small <- inla(formulaB.H.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, openmp.strategy="huge", config=T), verbose=T)
model.besag.S.UE.small <- inla(formulaB.S.UE.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, openmp.strategy="huge", config=T), verbose=T)
model.besag.S.OB.small <- inla(formulaB.S.OB.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, openmp.strategy="huge", config=T), verbose=T)
model.besag.HS.UE.small <- inla(formulaB.HS.UE.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, openmp.strategy="huge", config=T), verbose=T)
model.besag.HS.OB.small <- inla(formulaB.HS.OB.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, openmp.strategy="huge", config=T), verbose=T)
# Euclidean
model.Eucl.S.small <- inla(formulaB.S.Eucl.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, config=T), verbose=T)
model.Eucl.HS.small <- inla(formulaB.HS.Eucl.small,  family = "gaussian", data = phenoData.small, control.compute = list(dic=T,cpo=F, config=T), verbose=T)
# SPDE
model.SPDE.S.small = inla(formula = formulaS.small, data = inla.stack.data(stack.small),
            family = "normal", control.predictor =list(A=inla.stack.A.small(stack.small),compute = T),
            control.family=list(list(hyper=hyperResVarRest)),
            control.compute = list(dic=T,cpo=F, config=T), verbose=T)  

model.SPDE.HS.small = inla(formula = formulaHS.small, data = inla.stack.data(stackHS.small),
             family = "normal", control.predictor =list(A=inla.stack.A.small(stackHS.small),compute = T),
             control.family=list(list(hyper=hyperResVarRest)),
             control.compute = list(dic=T,cpo=F, config=T), verbose=T)

```


# MODEL COMPARISON (VARIANCE COMPONENTS, DIC VALUES)

Full data.

```{r eval=F}
G <- c(round(1/model.G$summary.hyperpar[2,1],2), "/", "/", round(1/model.G$summary.hyperpar[1,1],2), round(model.G$dic$dic,0))

GH <- c(round(1/model.H$summary.hyperpar[2,1],2), round(1/model.H$summary.hyperpar[3,1],2), "/", round(1/model.H$summary.hyperpar[1,1],2), round(model.H$dic$dic, 0))

GS.besag.OB <- c(round(1/model.besag.S.OB$summary.hyperpar[2,1],2), "/", round(1/model.besag.S.OB$summary.hyperpar[3,1],2), round(1/model.besag.S.OB$summary.hyperpar[1,1],2), round(model.besag.S.OB$dic$dic, 0))

GS.besag.UE <- c(round(1/model.besag.S.UE$summary.hyperpar[2,1],2), "/", round(1/model.besag.S.UE$summary.hyperpar[3,1],2), round(1/model.besag.S.UE$summary.hyperpar[1,1],2), round(model.besag.S.UE$dic$dic, 0))

GHS.besag.OB <- c(round(1/model.besag.HS.OB$summary.hyperpar[2,1],2), round(1/model.besag.HS.OB$summary.hyperpar[3,1],2), round(1/model.besag.HS.OB$summary.hyperpar[4,1],2), round(1/model.besag.HS.OB$summary.hyperpar[1,1],2), round(model.besag.HS.OB$dic$dic, 0))

GHS.besag.UE <- c(round(1/model.besag.HS.UE$summary.hyperpar[2,1],2), round(1/model.besag.HS.UE$summary.hyperpar[3,1],2), round(1/model.besag.HS.UE$summary.hyperpar[4,1],2), round(1/model.besag.HS.UE$summary.hyperpar[1,1],2), round(model.besag.HS.UE$dic$dic, 0))

GS.Eucl <- c(round(1/model.Eucl.S$summary.hyperpar[2,1],2), "/", round(1/model.Eucl.S$summary.hyperpar[3,1],2), round(1/model.Eucl.S$summary.hyperpar[1,1],2), round(model.Eucl.S$dic$dic, 0))

# GHS.Eucl <- c(round(1/model.Eucl.HS$summary.hyperpar[2,1],2), round(1/model.Eucl.HS$summary.hyperpar[3,1],2), round(1/model.Eucl.HS$summary.hyperpar[4,1],2), round(1/model.Eucl.HS$summary.hyperpar[1,1],2), round(model.Eucl.HS$dic$dic, 0))

GS.SPDE <- c(round(1/model.SPDE.S$summary.hyperpar[2,1],2), "/", round(model.SPDE.S$summary.hyperpar[4,1]^2,2), round(1/model.SPDE.S$summary.hyperpar[1,1],2), round(model.SPDE.S$dic$dic,0))

GHS.SPDE <- c(round(1/model.SPDE.HS$summary.hyperpar[2,1],2), round(1/model.SPDE.HS$summary.hyperpar[3,1],2), round(model.SPDE.HS$summary.hyperpar[5,1]^2,2), round(1/model.SPDE.HS$summary.hyperpar[1,1],2), round(model.SPDE.HS$dic$dic,0))

```


```{r}
Modeli <- cbind(G, GH, GS.besag.OB, GS.besag.UE, GHS.besag.OB, GHS.besag.UE, GS.Eucl, GS.SPDE, GHS.SPDE)
rownames(Modeli) <- c("genetic effect", "herd effect", "spatial effect", "residual", "DIC")
kable(Modeli,caption = "Variance components for random effects") %>%
  kable_styling("striped",full_width = F, font_size=15)



```


Small data.

```{r}
# rm(list=ls())
# load("workspaces/import_data.RData")
# load("workspaces/spde_small.RData")
# load("workspaces/Eucl_models.RData")
# load("workspaces/UE_models.RData")
```


```{r eval=F}
G.small <- c(round(1/model.G.small$summary.hyperpar[2,1],2), "/", "/", round(1/model.G.small$summary.hyperpar[1,1],2), round(model.G.small$dic$dic,0))

GH.small <- c(round(1/model.H.small$summary.hyperpar[2,1],2), round(1/model.H.small$summary.hyperpar[3,1],2), "/", round(1/model.H.small$summary.hyperpar[1,1],2), round(model.H.small$dic$dic, 0))

GS.besag.OB.small <- c(round(1/model.besag.S.OB.small$summary.hyperpar[2,1],2), "/", round(1/model.besag.S.OB.small$summary.hyperpar[3,1],2), round(1/model.besag.S.OB.small$summary.hyperpar[1,1],2), round(model.besag.S.OB.small$dic$dic, 0))

GS.besag.UE.small <- c(round(1/model.besag.S.UE.small$summary.hyperpar[2,1],2), "/", round(1/model.besag.S.UE.small$summary.hyperpar[3,1],2), round(1/model.besag.S.UE.small$summary.hyperpar[1,1],2), round(model.besag.S.UE.small$dic$dic, 0))

GHS.besag.OB.small <- c(round(1/model.besag.HS.OB.small$summary.hyperpar[2,1],2), round(1/model.besag.HS.OB.small$summary.hyperpar[3,1],2), round(1/model.besag.HS.OB.small$summary.hyperpar[4,1],2), round(1/model.besag.HS.OB.small$summary.hyperpar[1,1],2), round(model.besag.HS.OB.small$dic$dic, 0))

GHS.besag.UE.small <- c(round(1/model.besag.HS.UE.small$summary.hyperpar[2,1],2), round(1/model.besag.HS.UE.small$summary.hyperpar[3,1],2), round(1/model.besag.HS.UE.small$summary.hyperpar[4,1],2), round(1/model.besag.HS.UE.small$summary.hyperpar[1,1],2), round(model.besag.HS.UE.small$dic$dic, 0))

GS.Eucl.small <- c(round(1/model.Eucl.S.small$summary.hyperpar[2,1],2), "/", round(1/model.Eucl.S.small$summary.hyperpar[3,1],2), round(1/model.Eucl.S.small$summary.hyperpar[1,1],2), round(model.Eucl.S.small$dic$dic, 0))


GHS.Eucl.small <- c(round(1/model.Eucl.HS.small$summary.hyperpar[2,1],2), round(1/model.Eucl.HS.small$summary.hyperpar[3,1],2), round(1/model.Eucl.HS.small$summary.hyperpar[4,1],2), round(1/model.Eucl.HS.small$summary.hyperpar[1,1],2), round(model.Eucl.HS.small$dic$dic, 0))


GS.SPDE.small <- c(round(1/model.SPDE.S.small$summary.hyperpar[2,1],2), "/", paste(round(model.SPDE.S.small$summary.hyperpar[4,1]^2,2), "; range", round(model.SPDE.S.small$summary.hyperpar[3,1]),2), round(1/model.SPDE.S.small$summary.hyperpar[1,1],2), round(model.SPDE.S.small$dic$dic,0))

GHS.SPDE.small <- c(round(1/model.SPDE.HS.small$summary.hyperpar[2,1],2), round(1/model.SPDE.HS.small$summary.hyperpar[3,1],2), paste(round(model.SPDE.HS.small$summary.hyperpar[5,1]^2,3), "; range", round(model.SPDE.HS.small$summary.hyperpar[4,1]),2), round(1/model.SPDE.HS.small$summary.hyperpar[1,1],2), round(model.SPDE.HS.small$dic$dic,0))

```


```{r}
Modeli <- cbind(G.small, GH.small, GS.besag.OB.small, GS.besag.UE.small, GHS.besag.OB.small, GHS.besag.UE.small, GS.Eucl.small, GHS.Eucl.small, GS.SPDE.small, GHS.SPDE.small)
rownames(Modeli) <- c("genetic effect", "herd effect", "spatial effect", "residual", "DIC")
kable(Modeli,caption = "Variance components for random effects (small models)") %>%
  kable_styling("striped",full_width = F, font_size=15)




```



# INLA POSTERIOR SAMPLING

CHECK !!!

PEVD = Var(EBV_i - EBV_j) = Var(EBV_i) + Var(EBV_j) - 2Cov(EBV_i + EBV_j)

```{r}
# import Euclidean distance matrix
# import posterior samplings
load("workspaces/mc_samples.RData")
load("workspaces/Euclidean_dist_small.RData")
```


```{r}
# xxG, xxH, xxS, xxHS, xxS.spde, xxHS.spde

pipeline_conn_1 <- function(nEff=56465, nSample=100, samples_model, data=phenoData.small, nameEff="Geff"){

effects_sample <- matrix(NA, nrow=nEff, ncol=nSample)
nEff_full <- length(samples_model[[1]]$latent)
for(i in 1:nSample){
  effects_sample_full <- samples_model[[i]]$latent[1:nEff_full,]
  effects_sample[,i] <- effects_sample_full[grepl("^rowNumber", names(effects_sample_full))]
}
df_Row_eff <- data.frame("rowNumberAinv" = 1:nEff, nameEff = effects_sample)
rowNumber <- data.frame("rowNumberAinv" = data$rowNumberAinv)
df_Row_eff <- as.data.frame(merge(rowNumber, df_Row_eff, all.x=T))
df_Row_eff <- df_Row_eff[order(df_Row_eff$rowNumberAinv),]
row.names(df_Row_eff) <- df_Row_eff$rowNumberAinv
df_Row_eff$rowNumberAinv <- NULL
df_Row_eff <- data.matrix(df_Row_eff)
df_Row_eff
}


sampled.G.gen.small <- pipeline_conn_1(samples_model=sampled.G.small)
sampled.HS.SPDE.gen.small <- pipeline_conn_1(samples_model=sampled.HS.SPDE.small)
```

```{r}
RowVar <- function(x, ...) {
  rowSums((x - rowMeans(x, ...))^2, ...)/(dim(x)[2] - 1)
}

# Var(EBV_i); Var(EBV_j)
variance_animal.G <- RowVar(sampled.G.gen.small)
variance_animal.HS.SPDE <- RowVar(sampled.HS.SPDE.gen.small)

```


Check association 'distance : PEVD' !!!!

```{r}
pipeline_PEVD <- function(var_animal, samples){
  sum_var = outer(var_animal, -var_animal,'-') # Var(EBV_i) + Var(EBV_j)
  varcovM <- cov(t(samples), t(samples)) # Cov(EBV_i + EBV_j)
  pevd <- sum_var - 2*varcovM # # Var(EBV_i) + Var(EBV_j) - 2*Cov(EBV_i + EBV_j)
  pevd[lower.tri(pevd,diag=TRUE)] <- NA
  pevd_num <- as.vector(pevd)
  pevd_num <- pevd_num[!is.na(pevd_num)]
  pevd_num
}
pevd.G.small <- pipeline_PEVD(var_animal=variance_animal.G, samples=sampled.G.gen.small)
pevd.HS.SPDE.small <- pipeline_PEVD(var_animal=variance_animal.HS.SPDE, samples=sampled.HS.SPDE.gen.small)


pipeline_Eucl <- function(dist){
  dist[lower.tri(dist,diag=TRUE)] <- NA
  Eucl_dist_num <- as.vector(dist)
  Eucl_dist_num <- Eucl_dist_num[!is.na(Eucl_dist_num)]
  Eucl_dist_num
}

pevd.Eucl.small <- pipeline_Eucl(dist=paired.distances)

# ??????????????????????
cor(pevd.Eucl.small, pevd.G.small)
cor(pevd.Eucl.small, pevd.HS.SPDE.small)
cor(pevd.G.small, pevd.HS.SPDE.small)


```




